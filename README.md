# Features Implemented
- `operational_contract` - Your main business logic with `PiCO` token operations
- `icrc1_ledger_canister` - our ICRC-1 tokens which called `PiCO`
- `icrc2_ledger_canister` - our approval method for sending token
- `pico_frontend` - Your frontend (depends on operational_contract)
- `internet_identity` - Authentication

# `pico`

Welcome to your new `pico` project and to the Internet Computer development community. By default, creating a new project adds this README and some template files to your project directory. You can edit these template files to customize your project and to include your own code to speed up the development cycle.

To get started, you might want to explore the project directory structure and the default configuration file. Working with this project in your development environment will not affect any production deployment or identity tokens.

To learn more before you start working with `pico`, see the following documentation available online:

- [Quick Start](https://internetcomputer.org/docs/current/developer-docs/setup/deploy-locally)
- [SDK Developer Tools](https://internetcomputer.org/docs/current/developer-docs/setup/install)
- [Motoko Programming Language Guide](https://internetcomputer.org/docs/current/motoko/main/motoko)
- [Motoko Language Quick Reference](https://internetcomputer.org/docs/current/motoko/main/language-manual)

If you want to start working on your project right away, you might want to try the following commands:

```bash
cd pico/
dfx help
dfx canister --help
```

## Running the project locally

If you want to test your project locally, you can use the following commands:

```bash
# Starts the replica, running in the background
dfx start --background

# Deploys your canisters to the replica and generates your candid interface
dfx deploy
```

Once the job completes, your application will be available at `http://localhost:4943?canisterId={asset_canister_id}`.

If you have made changes to your backend canister, you can generate a new candid interface with

```bash
npm run generate
```

at any time. This is recommended before starting the frontend development server, and will be run automatically any time you run `dfx deploy`.

If you are making frontend changes, you can start a development server with

```bash
npm start
```

Which will start a server at `http://localhost:8080`, proxying API requests to the replica at port 4943.

### Note on frontend environment variables

If you are hosting frontend code somewhere without using DFX, you may need to make one of the following adjustments to ensure your project does not fetch the root key in production:

- set`DFX_NETWORK` to `ic` if you are using Webpack
- use your own preferred method to replace `process.env.DFX_NETWORK` in the autogenerated declarations
  - Setting `canisters -> {asset_canister_id} -> declarations -> env_override to a string` in `dfx.json` will replace `process.env.DFX_NETWORK` with the string in the autogenerated declarations
- Write your own `createActor` constructor

# PiCO Token & Operational Contract

A comprehensive Internet Computer (IC) project featuring the **PiCO** ICRC-1 token and an **Operational Contract** for managing token operations, NFT purchases, and transaction tracking.

## Project Structure

```
pico/
├── src/
│   ├── pico_backend/
│   │   ├── config.mo               # Centralized backend configuration
│   │   ├── operational.mo          # Operational Contract (Motoko)
│   │   ├── nft.mo                 # NFT Contract
│   │   ├── forums.mo              # Forums Contract
│   │   ├── preferences.mo         # User Preferences Contract
│   │   ├── token.mo               # Token Contract
│   │   └── openai.mo              # OpenAI Integration
│   ├── pico_frontend/
│   │   ├── src/config/
│   │   │   └── canisters.ts       # Frontend canister configuration
│   │   └── ...                    # React/TypeScript frontend
│   └── declarations/               # Generated type declarations
├── scripts/
│   ├── generate-canister-ids.js   # Frontend config generator
│   └── update-backend-config.js   # Backend config updater
├── docs/                           # Comprehensive documentation
├── dfx.json                        # Project configuration
├── icrc1_ledger.wasm.gz           # ICRC-1 Ledger WebAssembly
├── icrc1_ledger.did               # ICRC-1 Ledger Interface
└── README.md                       # This file
```

## PiCO Token Details

- **Name**: PiCO
- **Symbol**: PiCO
- **Standard**: ICRC-1 (with ICRC-2 support)
- **Decimals**: 8
- **Initial Supply**: 1,000,000 PiCO
- **Transfer Fee**: 0.0001 PiCO
- **Minter**: `igjqa-zhtmo-qhppn-eh7lt-5viq5-4e5qj-lhl7n-qd2fz-2yzx2-oczyc-tqe`

## Deployment

### Automated Deployment with Complete Canister Management

The project features a comprehensive, automated canister management system that eliminates hardcoded canister IDs and provides seamless synchronization between dfx deployment state and your application code - for both **frontend** and **backend**.

#### Quick Start

1. **Start the local IC replica:**
   ```bash
   dfx start --clean --background
   ```

2. **Deploy with automatic canister ID synchronization:**
   ```bash
   # Deploy locally with automatic ID generation and sync
   npm run deploy:local
   
   # OR deploy to IC mainnet
   npm run deploy:ic
   ```

3. **Start the frontend development server:**
   ```bash
   npm start
   ```

#### Manual Deployment Steps

If you prefer manual control:

1. **Deploy all canisters:**
   ```bash
   dfx deploy
   ```

2. **Synchronize canister IDs across frontend and backend:**
   ```bash
   npm run sync:canisters
   ```

3. **Deploy specific canisters:**
   ```bash
   # Deploy PiCO token ledger
   dfx deploy icrc1_ledger_canister
   
   # Deploy operational contract
   dfx deploy operational_contract
   
   # Deploy frontend
   dfx deploy pico_frontend
   ```

### Complete Canister Management System

The project uses a **dual-layer centralized configuration system**:

#### Frontend Configuration (`src/pico_frontend/src/config/canisters.ts`)
- **TypeScript interfaces** for type safety
- **Environment variable overrides** for custom configurations
- **Network detection** with automatic host/identity provider configuration
- **Priority system**: ENV vars > Generated IDs > Defaults

#### Backend Configuration (`src/pico_backend/config.mo`)
- **Single source of truth** for all Motoko contracts
- **Network-aware configuration** (local vs IC)
- **Utility functions** for token conversions and validation
- **Automatic synchronization** with dfx state

#### Available Commands

```bash
# Complete synchronization (recommended)
npm run sync:canisters          # Sync frontend + backend
npm run deploy:local            # Deploy + sync all
npm run deploy:ic               # Deploy IC + sync all

# Individual updates
npm run generate:canister-ids   # Frontend only
npm run update:backend-config   # Backend only

# Build with auto-sync
npm run build                   # Automatically syncs before building
```

#### Environment Variable Overrides

You can override any canister ID using environment variables:

```bash
# Override specific canister IDs
export CANISTER_ID_NFT_CONTRACT=your-custom-nft-id
export CANISTER_ID_OPERATIONAL_CONTRACT=your-custom-ops-id
export DFX_NETWORK=ic
npm start
```

#### Network Detection & Configuration

The system automatically detects the deployment network and configures:
- **Host URLs** (localhost:4943 for local, ic0.app for mainnet)
- **Identity providers** (local II canister vs identity.ic0.app)
- **Canister endpoints** based on the active network
- **Backend network settings** in Motoko contracts

#### Key Benefits

**Single Source of Truth** - All canister IDs centralized  
**Automatic Synchronization** - Always in sync with dfx state  
**Network Awareness** - Automatic local vs IC detection  
**Type Safety** - TypeScript + Motoko compile-time validation  
**Zero Manual Updates** - No hardcoded IDs anywhere  
**Better DX** - Simple npm scripts for everything

## Operational Contract API

### TOKEN -> ICRC1 Functions

#### `top_up` - Mint PiCO tokens to users
Mints new PiCO tokens to a specified user account.

**Syntax:**
```bash
dfx canister call operational_contract top_up '("USER_PRINCIPAL_ID", AMOUNT)'
```

**Examples:**
```bash
# Top up user with 100 PiCO tokens
dfx canister call operational_contract top_up '("xtzxu-fjc7d-ud3rp-qz6ad-23inu-drlyt-ceugf-tqoir-envkd-odkhn-aqe", 100)'

# Top up user with 50 PiCO tokens
dfx canister call operational_contract top_up '("rdmx6-jaaaa-aaaaa-aaadq-cai", 50)'
```

**Returns:**
```motoko
Result<{transaction_id: Nat; message: Text}, Text>
```

### OPERATIONAL Functions

#### `buy_nft` - Handle NFT purchases
Records NFT purchase transactions with PiCO token payments.

**Syntax:**
```bash
dfx canister call operational_contract buy_nft '("BUYER_PRINCIPAL_ID", NFT_ID, PRICE, FORUM_ID)'
```

**Examples:**
```bash
# Buy NFT with ID 1 for 25 PiCO tokens (no forum context)
dfx canister call operational_contract buy_nft '("xtzxu-fjc7d-ud3rp-qz6ad-23inu-drlyt-ceugf-tqoir-envkd-odkhn-aqe", 1, 25, null)'

# Buy NFT with forum context
dfx canister call operational_contract buy_nft '("xtzxu-fjc7d-ud3rp-qz6ad-23inu-drlyt-ceugf-tqoir-envkd-odkhn-aqe", 1, 25, opt 123)'
```

**Returns:**
```motoko
Result<{transaction_id: Nat; message: Text}, Text>
```

### Query Functions (Read-only)

#### `getUserBalance` - Get user's PiCO balance
```bash
dfx canister call operational_contract getUserBalance '("USER_PRINCIPAL_ID")'

# Example
dfx canister call operational_contract getUserBalance '("xtzxu-fjc7d-ud3rp-qz6ad-23inu-drlyt-ceugf-tqoir-envkd-odkhn-aqe")'
```

#### `getTransaction` - Get transaction by ID
```bash
dfx canister call operational_contract getTransaction '(TRANSACTION_ID)'

# Example
dfx canister call operational_contract getTransaction '(1)'
```

#### `getUserTransactions` - Get all transactions for a user
```bash
dfx canister call operational_contract getUserTransactions '("USER_PRINCIPAL_ID")'

# Example
dfx canister call operational_contract getUserTransactions '("xtzxu-fjc7d-ud3rp-qz6ad-23inu-drlyt-ceugf-tqoir-envkd-odkhn-aqe")'
```

#### `getAllTransactions` - Get all transactions (admin view)
```bash
dfx canister call operational_contract getAllTransactions '()'
```

#### `getTokenInfo` - Get PiCO token information
```bash
dfx canister call operational_contract getTokenInfo '()'
```

#### `isUserAdmin` - Check if user is admin
```bash
dfx canister call operational_contract isUserAdmin '("USER_PRINCIPAL_ID")'

# Example
dfx canister call operational_contract isUserAdmin '("igjqa-zhtmo-qhppn-eh7lt-5viq5-4e5qj-lhl7n-qd2fz-2yzx2-oczyc-tqe")'
```

#### `getLedgerCanisterId` - Get ledger canister ID
```bash
dfx canister call operational_contract getLedgerCanisterId '()'
```

#### `getTransactionCount` - Get total transaction count
```bash
dfx canister call operational_contract getTransactionCount '()'
```

## Transaction Data Structure

Each operational transaction contains:

```motoko
{
  transaction_id : Nat;           // Unique transaction ID
  from_principal_id : Text;       // Sender principal ID
  to_principal_id : Text;         // Recipient principal ID
  status : TransactionStatus;     // #Pending | #Completed | #Failed | #Cancelled
  price_token : Nat;              // Amount in PiCO tokens
  created_at : Int;               // Timestamp
  nft_id : ?Nat;                  // Optional NFT ID
  forum_id : ?Nat;                // Optional Forum ID
}
```

## Testing Examples

### 1. Create Mock User Identity
```bash
# Create new identity for testing
dfx identity new mock-user

# Get mock user's principal ID
dfx identity get-principal --identity mock-user
```

### 2. Top Up Mock User
```bash
# Top up mock user with 100 PiCO tokens
dfx canister call operational_contract top_up '("MOCK_USER_PRINCIPAL_ID", 100)'
```

### 3. Check Balance
```bash
# Check mock user's balance
dfx canister call operational_contract getUserBalance '("MOCK_USER_PRINCIPAL_ID")'
```

### 4. Simulate NFT Purchase
```bash
# Mock user buys NFT
dfx canister call operational_contract buy_nft '("MOCK_USER_PRINCIPAL_ID", 1, 25, null)'
```

### 5. View Transactions
```bash
# View all transactions for mock user
dfx canister call operational_contract getUserTransactions '("MOCK_USER_PRINCIPAL_ID")'

# View specific transaction
dfx canister call operational_contract getTransaction '(1)'
```

## Direct ICRC-1 Ledger Operations

You can also interact directly with the PiCO token ledger:

### Check Token Name & Symbol
```bash
dfx canister call icrc1_ledger_canister icrc1_name '()'
dfx canister call icrc1_ledger_canister icrc1_symbol '()'
```

### Check Balance
```bash
dfx canister call icrc1_ledger_canister icrc1_balance_of '(record { owner = principal "USER_PRINCIPAL_ID" })'
```

### Transfer Tokens
```bash
dfx canister call icrc1_ledger_canister icrc1_transfer '(record { 
  to = record { owner = principal "RECIPIENT_PRINCIPAL_ID" }; 
  amount = 1000000000 
})'
```

## Admin Functions

As the admin/minter (`igjqa-zhtmo-qhppn-eh7lt-5viq5-4e5qj-lhl7n-qd2fz-2yzx2-oczyc-tqe`), you can:

- Mint new PiCO tokens using `top_up`
- View all transactions using `getAllTransactions`
- Manage the operational contract

## Frontend Integration

The operational contract is designed to work with your frontend application. Key integration points:

1. **User Authentication**: Use Internet Identity for user login
2. **Balance Display**: Call `getUserBalance` to show user's PiCO balance
3. **Transaction History**: Call `getUserTransactions` to show user's activity
4. **NFT Purchases**: Call `buy_nft` when users purchase NFTs
5. **Top-up Feature**: Call `top_up` for admin token distribution

## Development Notes

- **Local Testing**: All commands shown work in local development environment
- **Mainnet Deployment**: Use `npm run deploy:ic` for automated mainnet deployment  
- **Zero Hardcoded IDs**: Complete elimination of hardcoded canister IDs across frontend and backend
- **Automatic Synchronization**: Canister IDs automatically sync with dfx state during deployment
- **Network Flexibility**: Seamless switching between local and IC networks with automatic detection
- **Type Safety**: TypeScript + Motoko compile-time validation ensures configuration consistency
- **Error Handling**: All functions return `Result` types for proper error handling
- **Transaction Tracking**: Every operation creates a trackable transaction record
- **Developer Experience**: Simple npm scripts handle complex configuration management automatically

## Resources

- [Internet Computer Documentation](https://internetcomputer.org/docs)
- [Motoko Documentation](https://internetcomputer.org/docs/motoko/home)
- [ICRC-1 Token Standard](https://internetcomputer.org/docs/defi/token-ledgers/setup/icrc1_ledger_setup)
- [DFX CLI Reference](https://internetcomputer.org/docs/cli-reference/dfx-parent)

---

**Happy Building!**
